/*
jvalidator  0.3.9
修改源码 2014-12-26 14:31:42
function _exists(e){return $(e).closest("body").size()>0&&$(e).is(":visible")}
改为
function _exists(e){return $(e).closest("body").size()>0&&($(e).is(":visible")||$(e).attr("type")=="hidden")}
使其可以验证hidden,满足特殊的业务需求
*/
function _tokenized(a){var c,d,b=[];for(c=0;c<a.length;c++)switch(d=a.charAt(c)){case"(":case")":case"!":case"&":case"|":b.push(d),b.push("");break;default:b.length?b[b.length-1]+=d:b.push(d)}return b}function _parse(a){for(var d,e,b=[],c=null;void 0!==(d=a.shift());)if(d)switch(d){case"(":case")":case"!":case"&":case"|":b.push(d);break;default:if(e=d.match(regName),!e)continue;if(c="@"==e[1].charAt(0)?{name:"@",elemName:e[1].replace("@","")}:{name:e[1]},!PARSER[c.name])throw"not found parser's name : "+c.name;e[2]&&(c.value=e[2].replace("[","").replace("]","")),b.push(c),c=null}return b}function FieldChecker(a){this.element=a,this.$element=$(a),this.$form=this.$element.closest($valiTag),this.async=new Async}function FormValidator(a){if(!a)throw"[ERROR] 验证元素不存在";this.form=$valiTag=a,this.$form=$(a),this.async=new Async}function _exists(a){return $(a).closest("body").size()>0&&($(a).is(":visible")||"hidden"==$(a).attr("type"))}function _getFieldValidator(a){return"INPUT"!=a.nodeName||"checkbox"!=a.type&&"radio"!=a.type||(a=$(a).closest($valiTag).find("input[data-"+CONSTANT.PATTERN+"][name="+a.name+"]")[0]),a&&$(a).attr("data-"+CONSTANT.PATTERN)?a._field_validator?a._field_validator:a._field_validator=new FieldChecker(a):void 0}function _parse_selector_syntax(a){return(a||"").replace(/@([a-z][a-z0-9]*)\b/gi,"[name=$1]")}function addPattern(a,b){if(!(a&&b&&b.message&&b.validate))throw"[ERROR] add pattern - on param:name:string,{message:string,validate:function}";PATTERNS[a]=$.extend({name:a},b),parser.add(a,b)}var PARSER,regName,parser,$valiTag,PATTERNS,CONSTANT,Async=function(){this.reqs=[],this.status=0};Async.prototype.addRequest=function(a){0==this.status&&this.reqs.push(a)},Async.prototype.go=function(){var a,b,c,d,e;if(0==this.status)for(this.status=1,a=this,b=this.reqs,c=this.reqs.length,d=0;d<b.length;d++){if(e=b[d],0==this.status)return;e(function(){c--,0==c&&a.finish()})}},Async.prototype.finish=function(){this.status=0,this.onfinished&&this.onfinished()},Async.prototype.clear=function(){0==this.status&&(this.reqs=[])},PARSER={},regName=/^(@?[\w\-]+)(\[.+\])?$/,parser={add:function(a,b){PARSER[a]=b||{},PARSER[a].name=a},parse:function(a){var b=_tokenized(a),c=_parse(b);return c}},$valiTag=null,PATTERNS={},CONSTANT={PATTERN:"jvalidator-pattern",PLACEHOLDER:"jvalidator-placeholder",CNAME:"jvalidator-cname",MESSAGE_ATTR:"__jvalidator_messages__",FIELD_EVENTS:"__jvalidator_events__",DEBUG:"jvalidator-debug"},FieldChecker.prototype={_getPatternMessage:function(a){var c,d,b=[];for(c=0;c<a.length;c++)if(d=a[c],d.name)b.push(d.getMessage());else switch(d){case"&&":b.push(" 并且 ");break;case"||":b.push(" 或者 ");break;case"!":b.push("不")}return b.join("")},_checkPatternResult:function(str,results){var i,p,all,arr,self=this,rstr=[];for(i=0;i<results.length;i++)p=results[i],p.name?rstr.push(p.result):rstr.push(p);return this.$form.attr("data-"+CONSTANT.DEBUG)&&console.info(this,this.element,str,rstr.join("")),all=eval(rstr.join("")),all?[]:(arr=$.grep(results,function(a){return a.name&&a.result===!1}),arr.getMessage=function(){return self._getPatternMessage(results)},arr)},checkPattern:function(){var a=this.$element,b=a.attr("data-"+CONSTANT.PATTERN);try{parser.parse(b)}catch(d){console.error(this.element,"验证器语法有错误，请检查",b),console.error("错误可能是：",d)}},check:function(a,b){var f,g,h,i,c=this,d=this.async;this.element,f=this.$element,g=this.value(),h=f.attr("data-"+CONSTANT.PATTERN),i=parser.parse(h),d.clear(),d.onfinished=function(){var d=c._checkPatternResult(h,i);c.after_check(0==d.length,d,a),b&&b(0==d.length,d)},$.each(i,function(){if(this.name){var b=$.extend(this,{element:c.element,$element:c.$element,$form:c.$form,getMessage:function(){return c._getMessage.call(this,g)},parseNameSymbol:function(a){return"@"!==a.charAt(0)?null:this.$form.find(_parse_selector_syntax(a))[0]},getNameSymbol:function(){return this.parseNameSymbol("@"+this.elemName)},getValueSymbol:function(){var a=this.parseNameSymbol(this.value);return a?a:this.value},getElementValue:function(a){if(a=$(a)[0],!a)return"";var b=_getFieldValidator(a);return b?b.value():c.value.call({element:a,$element:$(a),$form:c.$form})},getElementName:function(a){var b=$(a);return b.attr("data-"+CONSTANT.CNAME)?b.attr("data-"+CONSTANT.CNAME):b.attr("name")}},PATTERNS[this.name]);!function(b){d.addRequest(function(c){b.validate(g,function(a){b.result=a,c()},a)})}(b)}}),d.go()},_getMessage:function(a){var b=this,c=this.name,d=this.element,e=this.$element,f=this.$form,g=a||_getFieldValidator(d).value(),h=e.attr("data-jvalidator-message")||(d[CONSTANT.MESSAGE_ATTR]?d[CONSTANT.MESSAGE_ATTR][c]:null)||(f[0][CONSTANT.MESSAGE_ATTR]?f[0][CONSTANT.MESSAGE_ATTR][c]:null)||PATTERNS[c].message;return h=h.replace(/%val\b/g,g),h=h.replace(/%name\b/g,d.name),h=h.replace(/%cname\b/g,e.attr("data-"+CONSTANT.CNAME)),h=h.replace(/=%argu\b/g,function(){var a=b.parseNameSymbol(b.value);return a&&a.tagName?b.getElementValue(a):b.value}),h=h.replace(/%argu\b/g,function(){var a=b.parseNameSymbol(b.value);return a&&a.tagName?b.getElementName(a):b.value}),h=h.replace(/@@/g,function(){var e,d=f.find(_parse_selector_syntax("@"+b.elemName))[0];return d?(e=$(d),e.attr("data-"+CONSTANT.CNAME)?e.attr("data-"+CONSTANT.CNAME):e.attr("name")):""}),h=h.replace(/=@([^\s]*)\b/g,function(a,c){return b.getElementValue(f.find("[name="+c+"]"))}),h=h.replace(/@([^\s]*)\b/g,function(a,c){return b.getElementName(f.find("[name="+c+"]"))||""})},value:function(){var d,e,a=this.element,b=this.$element,c=this.$form;switch(a.tagName.toLowerCase()){case"input":switch(a.type){case"radio":return c.find("input[name="+a.name+"]:radio:checked").val();case"checkbox":return c.find("input[name="+a.name+"]:checkbox:checked").map(function(){return this.value}).toArray().join(",");case"text":return d=b.attr("data-"+CONSTANT.PLACEHOLDER),d===a.value?"":a.value;case"hidden":case"password":return a.value}break;case"select":return a.value;case"textarea":return d=b.attr("data-"+CONSTANT.PLACEHOLDER),d===a.value?"":a.value;default:return e=b.attr("data-value"),"undefined"!=typeof e?e:(e=a.value,"undefined"!=typeof e?e:e)}},after_check:function(a,b,c){var d=a?"success":"fail",e=this.$element.data(CONSTANT.FIELD_EVENTS+d);e||(e=this.$form.data(CONSTANT.FIELD_EVENTS+d)),e&&"function"==typeof e&&e.call(this,c,b)}},FormValidator.prototype={_getAllFieldValidator:function(){return this.$form.find("[data-"+CONSTANT.PATTERN+"]").filter(function(){return _exists(this)&&!this.disabled}).map(function(){return _getFieldValidator(this)}).toArray()},checkAllPatterns:function(){var a=this._getAllFieldValidator();$.each(a,function(){this.checkPattern()})},validateAll:function(a){var c,d,e,f,g;if(this.$form,c=this.async,d=this._getAllFieldValidator(),e=[],c.clear(),c.onfinished=function(){a&&a(0==e.length,e)},!d.length)return a(!0,[]);for(f=0;f<d.length;f++)g=d[f],function(a){c.addRequest(function(b){a.check(null,function(a,c){a||e.push(c),b()})})}(g);c.go()},when:function(a,b){var c,d,e,f,g,h,i;"string"!=typeof a&&(b=a,a=""),c={},d=a||"[data-"+CONSTANT.PATTERN+"]",e=this.$form.find(d).filter("input:checkbox"),e.length&&e.each(function(){d+=","+_parse_selector_syntax("@"+this.name)}),f=this.$form.find(d).filter("input:radio"),f.length&&f.each(function(){d+=","+_parse_selector_syntax("@"+this.name)}),$.isArray(b)?c[d]=b:$.isPlainObject(b)&&$.extend(c,b);for(g in c)h=_parse_selector_syntax(g),i=c[g]||[],i.length&&(i=i.join(" "),this.$form.undelegate(h,i),this.$form.delegate(h,i,function(a){var b=_getFieldValidator(this);b&&b.check(a)}))},setMessage:function(a,b,c){2==arguments.length&&(c=b,b=a,a=null);var d,e=this.$form[0];a?this.$form.find(_parse_selector_syntax(a)).each(function(){var a=this;d=a[CONSTANT.MESSAGE_ATTR]=a[CONSTANT.MESSAGE_ATTR]||{},d[b]=c}):(d=e[CONSTANT.MESSAGE_ATTR]=e[CONSTANT.MESSAGE_ATTR]||{},d[b]=c)},success:function(a,b){this._bind_field_event("success",a,b)},fail:function(a,b){this._bind_field_event("fail",a,b)},_bind_field_event:function(a,b,c){if(a)if("function"==typeof b&&(c=b,b=null),b){var d=_parse_selector_syntax(b);this.$form.find(d).each(function(){$(this).data(CONSTANT.FIELD_EVENTS+a,c)})}else this.$form.data(CONSTANT.FIELD_EVENTS+a,c)}},$.fn.jvalidator=function(){var b,a=$(this).first();return a.data("FormValidator")?a.data("FormValidator"):(b=new FormValidator(a[0]),a.data("FormValidator",b),b)},$.extend({jvalidator:{addPattern:addPattern,PATTERNS:PATTERNS,getFieldValidator:function(a){return _getFieldValidator(a)}}}),addPattern("required",{message:"必须填写",validate:function(a,b){b(""!==a)}}),addPattern("non-required",{message:"允许为空",validate:function(a,b){b(""===a)}}),addPattern("numeric",{message:"必须是数字",validate:function(a,b){b(/^\d+$/.test(a))}}),addPattern("int",{message:"必须是整数",validate:function(a,b){b(/^\-?\d+$/.test(a))}}),addPattern("decimal",{message:"必须是小数",validate:function(a,b){b(/^\-?\d*\.?\d+$/.test(a))}}),addPattern("alpha",{message:"必须是字母",validate:function(a,b){b(/^[a-z]+$/i.test(a))}}),addPattern("alpha_numeric",{message:"必须为字母或数字",validate:function(a,b){b(/^[a-z0-9]+$/i.test(a))}}),addPattern("alpha_dash",{message:"必须为字母或数字及下划线等特殊字符",validate:function(a,b){b(/^[a-z0-9_\-]+$/i.test(a))}}),addPattern("chs",{message:"必须是中文字符",validate:function(a,b){b(/^[\\u4E00-\\u9FFF]+$/i.test(a))}}),addPattern("chs_numeric",{message:"必须是中文字符或数字",validate:function(a,b){b(/^[\\u4E00-\\u9FFF0-9]+$/i.test(a))}}),addPattern("chs_numeric",{message:"必须是中文字符或数字及下划线等特殊字符",validate:function(a,b){b(/^[\\u4E00-\\u9FFF0-9_\-]+$/i.test(a))}}),addPattern("match",{argument:!0,message:"必须与 %argu 相同",validate:function(a,b){var c=this.getValueSymbol(),d=c&&c.tagName?this.getElementValue(c):c;b(d===a)}}),addPattern("contain",{argument:!0,message:'必须包含"%argu"的内容',validate:function(a,b){var c=this.getValueSymbol(),d=c&&c.tagName?this.getElementValue(c):c;b(!!~a.indexOf(d))}}),addPattern("@",{argument:!0,message:"@@必须为 %argu",validate:function(a,b){var e,f,c=this.getValueSymbol(),d=this.getNameSymbol();null===c||null===d?b(!1):(e=c&&c.tagName?this.getElementValue(c):c,f=d&&d.tagName?this.getElementValue(d):d,b(e===f))}}),addPattern("passport",{message:"护照格式错误或过长",validate:function(a,b){b(/^[a-zA-Z0-9]{0,20}$/i.test(a))}}),addPattern("email",{message:"邮件地址错误",validate:function(a,b){b(/^[a-zA-Z0-9.!#$%&amp;'*+\-\/=?\^_`{|}~\-]+@[a-zA-Z0-9\-]+(?:\.[a-zA-Z0-9\-]+)*$/.test(a))}}),addPattern("min_length",{argument:!0,message:"最少输入%argu个字",validate:function(a,b){var c=parseInt(this.value,10);b(a.length>=c)}}),addPattern("max_length",{argument:!0,message:"最多输入%argu个字",validate:function(a,b){var c=parseInt(this.value,10);b(a.length<=c)}}),addPattern("length",{argument:!0,message:"长度必须为%argu个字符",validate:function(a,b){var c=parseInt(this.value,10);b(a.length===c)}}),addPattern("greater_than",{argument:!0,message:"必须大于%argu",validate:function(a,b){var c=parseInt(a,10),d=this.parseNameSymbol(this.value);d=parseFloat(d&&d.tagName?this.getElementValue(d):this.value),b(c>d)}}),addPattern("less_than",{argument:!0,message:"必须小于%argu",validate:function(a,b){var c=parseInt(a,10),d=this.parseNameSymbol(this.value);d=parseFloat(d&&d.tagName?this.getElementValue(d):this.value),b(d>c)}}),addPattern("equal",{argument:!0,message:"必须等于%argu",validate:function(a,b){var c=parseInt(a,10),d=this.parseNameSymbol(this.value);d=parseFloat(d&&d.tagName?this.getElementValue(d):this.value),b(c==d)}}),addPattern("ip",{message:"必须符合ip格式",validate:function(a,b){b(/^((25[0-5]|2[0-4]\d|1\d{2}|\d{1,2})\.){3}(25[0-5]|2[0-4]\d|1\d{2}|\d{1,2})$/i.test(a))}}),addPattern("date",{message:"必须符合日期格式 YYYY-MM-DD",validate:function(a,b){b(/^\d\d\d\d\-\d\d\-\d\d$/.test(a))}});