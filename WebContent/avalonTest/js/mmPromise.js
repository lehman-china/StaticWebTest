define(["avalon"],function(b){var h=function(j){this._callbacks=[];var i=this;if(typeof this!=="object"){throw new TypeError("Promises must be constructed via new")}if(typeof j!=="function"){throw new TypeError("not a function")}j(function(k){e(i,k)},function(k){a(i,k)})};var f=typeof window.setImmediate==="function"?function(i){window.setImmediate(i)}:function(i){window.setTimeout(i,0)};h.resolve=function(i){return new h(function(j){j(i)})};h.reject=function(i){return new h(function(k,j){j(i)})};h.prototype={constructor:h,_state:"pending",_fired:false,_fire:function(i,j){if(this._state==="rejected"){if(typeof j==="function"){j(this._value)}else{throw this._value}}else{if(typeof i==="function"){i(this._value)}}},_then:function(j,k){if(this._fired){var i=this;f(function(){i._fire(j,k)})}else{this._callbacks.push({onSuccess:j,onFail:k})}},then:function(j,k){var i=this;return new h(function(m,l){i._then(function(n){if(typeof j==="function"){try{n=j(n)}catch(o){l(o);return}}m(n)},function(n){if(typeof k==="function"){try{n=k(n)}catch(o){l(o);return}m(n)}else{l(n)}})})},"catch":function(i){return this.then(null,i)},done:function(i){return this.then(i)},fail:function(i){return this.then(null,i)}};function e(j,i){if(j._state!=="pending"){return}j._state="fulfilled";if(i&&typeof i.then==="function"){var k=i instanceof h?"_then":"then";i[k](function(l){c(j,l)},function(l){j._state="rejected";c(j,l)})}else{c(j,i)}}function a(j,i){if(j._state!=="pending"){return}j._state="rejected";c(j,i)}function c(j,i){j._fired=true;j._value=i;f(function(){j._callbacks.forEach(function(k){j._fire(k.onSuccess,k.onFail)})})}function g(l,k){var m=0,i=[],j;return new h(function(r,q){function o(t,s){t.then(function(u){if(!j){i[s]=u;m++;if(l||m>=k.length){r(l?u:i);j=true}}},function(u){j=true;q(u)})}for(var p=0,n=k.length;p<n;p++){o(k[p],p)}})}h.all=function(){return g(false,arguments)};h.race=function(){return g(true,arguments)};var d=window.Promise;if(/native code/.test(window.Promise)){d.prototype.done=h.prototype.done;d.prototype.fail=h.prototype.fail;d.any=d.race}else{h.any=h.race;window.Promise=h}b.mmPromise=h;return b});
